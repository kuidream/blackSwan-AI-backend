# blackSwan AI Backend - Cursor Rules

## é¡¹ç›®æ¦‚è¿°

blackSwan æ˜¯ä¸€ä¸ªåŸºäºç°å®æ˜ å°„çš„è‡ªåŠ¨æ¼”è¿›å¼ RPG æ¸¸æˆåç«¯ç³»ç»Ÿï¼Œé‡‡ç”¨ Golang + PostgreSQL æŠ€æœ¯æ ˆã€‚

## Agent Skills ä½“ç³»

æœ¬é¡¹ç›®ä½¿ç”¨ä¸“ä¸šåŒ–çš„ Agent Skills ä½“ç³»ï¼Œè¯¦è§ `.cursor/skills/README.md`

å¯ç”¨æŠ€èƒ½ï¼š
- **database-architect**ï¼šæ•°æ®åº“æ¶æ„è®¾è®¡å’Œ Schema ç®¡ç†
- **go-backend-dev**ï¼šGo åç«¯ä¸šåŠ¡é€»è¾‘å®ç°
- **quality-assurance**ï¼šä»£ç æµ‹è¯•å’Œè´¨é‡å®¡æŸ¥
- **project-navigator**ï¼šé¡¹ç›®æ¶æ„å¯¼èˆªå’Œæ–‡æ¡£æŸ¥è¯¢

## ä¸‰å¤§é“å¾‹

### 1. æ•°æ®åº“é“å¾‹
**å•ä¸€äº‹å®æ¥æº**: `.ai/database/schema.sql` æ˜¯æ•°æ®åº“ç»“æ„çš„å”¯ä¸€çœŸç†

- ä¸¥æ ¼åŒ¹é… schema.sql ä¸­çš„å­—æ®µåã€ç±»å‹ã€çº¦æŸ
- è¡¨åä½¿ç”¨å•æ•°å½¢å¼ï¼ˆplayer, market_orderï¼‰
- å­—æ®µä½¿ç”¨ snake_caseï¼ˆcreated_at, player_idï¼‰
- é‡‘é¢/æ•°é‡ä½¿ç”¨ NUMERIC(30, 10)ï¼Œ**ä¸¥ç¦ä½¿ç”¨ float**
- ä¸»é”®ä½¿ç”¨ UUIDï¼Œé»˜è®¤å€¼ gen_random_uuid()
- æ—¶é—´æˆ³ä½¿ç”¨ TIMESTAMPTZï¼Œé»˜è®¤å€¼ now()

**Schema å˜æ›´æµç¨‹**ï¼šä¿®æ”¹ schema.sql â†’ Atlas æ¨é€ â†’ æ›´æ–°ä»£ç 

### 2. æ¥å£é“å¾‹
**å¥‘çº¦æ–‡æ¡£**: `.ai/api/api-reference.md` æ˜¯å¯¹å¤–æ‰¿è¯ºçš„ API å¥‘çº¦

- Handler ä»£ç ä¸¥æ ¼éµå®ˆ Request/Response ç»“æ„
- ç»Ÿä¸€å“åº”æ ¼å¼ï¼šrequest_id, server_time, data/error
- æ‰€æœ‰å†™æ“ä½œæ”¯æŒ Idempotency-Key
- æ—¶é—´ä½¿ç”¨ Unix ç§’æˆ– RFC3339 (UTC)
- é‡‘é¢/æ•°é‡ä½¿ç”¨å­—ç¬¦ä¸²æˆ– decimalï¼Œé¿å… float
- Base URL ä»¥ /v1 å¼€å¤´

### 3. å·¥ç¨‹é“å¾‹
**ç»“æ„æ–‡æ¡£**: `project_structure.tree` å®šä¹‰ä»£ç ç»„ç»‡æ–¹å¼

åˆ†å±‚æ¶æ„ï¼ˆä¾èµ–å•å‘ï¼‰ï¼š
```
Handler â†’ Usecase â†’ Repository â†’ Domain
```

èŒè´£åˆ’åˆ†ï¼š
- Handlerï¼šè§£æè¯·æ±‚ã€å‚æ•°æ ¡éªŒã€DTO æ˜ å°„
- Usecaseï¼šä¸šåŠ¡ç¼–æ’ã€äº‹åŠ¡æ§åˆ¶
- Repositoryï¼šæ•°æ®è®¿é—®ã€GORM æ“ä½œ
- Domainï¼šé¢†åŸŸæ¨¡å‹ã€ä¸šåŠ¡è§„åˆ™ã€æ¥å£å®šä¹‰

**ç¦æ­¢å¾ªç¯ä¾èµ–**ï¼šDomain ä¸å¾—ä¾èµ–ä»»ä½•å¤–éƒ¨åŒ…ï¼ˆé™¤æ ‡å‡†åº“ï¼‰

## ç¼–ç è§„èŒƒ

### å‘½åè§„èŒƒ
```go
package marketengine           // å°å†™
type IMarketService interface{}// I + åè¯
type MarketTick struct{}       // å¤§é©¼å³°
func CalculatePrice() {}       // å¤§é©¼å³°ï¼ˆå…¬å¼€ï¼‰
func calculateDelta() {}       // å°é©¼å³°ï¼ˆç§æœ‰ï¼‰
var playerBalance int64        // å°é©¼å³°
const MaxDailySteps = 20000    // å¤§é©¼å³°
```

### ç¦æ­¢ä½¿ç”¨
- Emoji è¡¨æƒ…ï¼šğŸš€âœ…âŒğŸ’¡âš¡â­ğŸŒŸğŸ¨ğŸ”¥ğŸ‰
- å›¾å½¢ç¬¦å·ï¼šâ†’ â† â†‘ â†“ â˜… â˜† â—† â—‡ â— â—‹
- ç‰¹æ®Šå­—ç¬¦ï¼šâ€» â˜… â˜† â™  â™£ â™¥ â™¦
- è¿‡åº¦è£…é¥°ï¼š=== --- ***

### æ³¨é‡Šè§„èŒƒ
```go
// æ­£ç¡®ï¼šç®€æ´å®ç”¨
// CalculateSourceReward è®¡ç®—æºç‚¹å¥–åŠ±
// åŸºäº IoT æ•°æ®å’Œå½“æ—¥é£æ ¼é…ç½®è®¡ç®—ç©å®¶å¯è·å¾—çš„æºç‚¹æ•°é‡
func CalculateSourceReward(steps int, styleConfig *StyleConfig) (int64, error) {
    // å®ç°é€»è¾‘
}
```

### é”™è¯¯å¤„ç†
```go
if err != nil {
    return nil, fmt.Errorf("failed to calculate reward: %w", err)
}

var (
    ErrInsufficientBalance = errors.New("insufficient balance")
    ErrInvalidPrice = errors.New("invalid price")
)
```

## æ•°æ®åº“æ“ä½œ

### ä½¿ç”¨äº‹åŠ¡
```go
func (r *OrderRepository) CreateOrder(order *Order) error {
    return r.db.Transaction(func(tx *gorm.DB) error {
        if err := tx.Create(order).Error; err != nil {
            return fmt.Errorf("failed to create order: %w", err)
        }
        
        if err := tx.Model(&PlayerBalance{}).
            Where("player_id = ? AND asset = ?", order.PlayerID, "SOURCE").
            Update("available_amount", gorm.Expr("available_amount - ?", order.TotalCost)).
            Error; err != nil {
            return fmt.Errorf("failed to update balance: %w", err)
        }
        
        return nil
    })
}
```

### é‡‘é¢å­—æ®µ
```go
// æ­£ç¡®ï¼šä½¿ç”¨ decimal
import "github.com/shopspring/decimal"

type Order struct {
    RequestedQty decimal.Decimal `gorm:"type:numeric(30,10)"`
    AvgPrice     decimal.Decimal `gorm:"type:numeric(30,10)"`
}

totalCost := order.RequestedQty.Mul(order.AvgPrice)
```

## API å¼€å‘

### å¹‚ç­‰æ€§
```go
func (h *OrderHandler) PlaceOrder(c *gin.Context) {
    idempotencyKey := c.GetHeader("Idempotency-Key")
    if idempotencyKey == "" {
        c.JSON(400, ErrorResponse{Error: "Idempotency-Key is required"})
        return
    }
    
    existing, _ := h.orderService.GetByIdempotency(playerID, idempotencyKey)
    if existing != nil {
        c.JSON(200, SuccessResponse{Data: existing})
        return
    }
    // ...
}
```

### ç»Ÿä¸€å“åº”
```go
type SuccessResponse struct {
    RequestID  string      `json:"request_id"`
    ServerTime int64       `json:"server_time"`
    Data       interface{} `json:"data"`
}

type ErrorResponse struct {
    RequestID  string       `json:"request_id"`
    ServerTime int64        `json:"server_time"`
    Error      ErrorDetail  `json:"error"`
}
```

## æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“æŸ¥è¯¢
```go
// ä½¿ç”¨ç´¢å¼•
db.Where("player_id = ? AND created_at > ?", playerID, startTime).Find(&orders)

// é¢„åŠ è½½
db.Preload("Player").Preload("Position").Find(&orders)
```

### Redis ç¼“å­˜
```go
func (s *WorldService) GetTodayStyle() (*StyleConfig, error) {
    key := fmt.Sprintf("world:style:%s", date)
    
    cached, err := s.cache.Get(ctx, key).Result()
    if err == nil {
        return ParseStyleConfig(cached), nil
    }
    
    config, err := s.repo.GetStyleByDate(date)
    if err != nil {
        return nil, err
    }
    
    s.cache.Set(ctx, key, config.ToJSON(), 24*time.Hour)
    return config, nil
}
```

## æµ‹è¯•è§„èŒƒ

### è¡¨é©±åŠ¨æµ‹è¯•
```go
func TestCalculateSourceReward(t *testing.T) {
    tests := []struct {
        name     string
        steps    int
        expected int64
        wantErr  bool
    }{
        {"æ­£å¸¸æ­¥æ•°", 1000, 100, false},
        {"è¶…è¿‡ä¸Šé™", 25000, 2000, false},
        {"è´Ÿæ•°æ­¥æ•°", -100, 0, true},
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            got, err := CalculateSourceReward(tt.steps)
            if (err != nil) != tt.wantErr {
                t.Errorf("error = %v, wantErr %v", err, tt.wantErr)
                return
            }
            if got != tt.expected {
                t.Errorf("got %v, want %v", got, tt.expected)
            }
        })
    }
}
```

## å‚è€ƒæ–‡æ¡£

### æ ¸å¿ƒæ–‡æ¡£
- æ•°æ®åº“ Schemaï¼š`.ai/database/schema.sql`
- API å‚è€ƒï¼š`.ai/api/api-reference.md`
- é¡¹ç›®ç»“æ„ï¼š`project_structure.tree`

### æ¶æ„æ–‡æ¡£
- æ ¸å¿ƒæ¶æ„ï¼š`.ai/docs/01-architecture.md`
- ä¸–ç•Œè§‚è®¾å®šï¼š`.ai/docs/02-world-setting.md`
- æ—¶ç©ºæ˜ å°„ï¼š`.ai/docs/03-time-mapping.md`
- å¸‚åœºæœºåˆ¶ï¼š`.ai/docs/04-market-mechanism.md`
- æŠ€æœ¯å®ç°ï¼š`.ai/docs/05-tech-implementation.md`
- ç»æµæ¨¡å‹ï¼š`.ai/docs/06-economy-model.md`

### æ¨¡å—æ–‡æ¡£
- IoT ç³»ç»Ÿï¼š`.ai/docs/modules/iot-system.md`
- å¸‚åœºç³»ç»Ÿï¼š`.ai/docs/modules/market-system.md`
- San å€¼ç³»ç»Ÿï¼š`.ai/docs/modules/sanity-system.md`
- NPC äº’åŠ¨ï¼š`.ai/docs/modules/npc-interaction.md`
- AI æ¼”è¿›ï¼š`.ai/docs/modules/ai-evolution.md`

## é‡è¦æé†’

1. ä½¿ç”¨ Agent Skills å¤„ç†ä¸“ä¸šä»»åŠ¡ï¼ˆè¯¦è§ `.cursor/skills/README.md`ï¼‰
2. æ•°æ®åº“å­—æ®µå¿…é¡»ä¸ schema.sql å®Œå…¨ä¸€è‡´
3. API æ¥å£å¿…é¡»ä¸ api-reference.md å®Œå…¨ä¸€è‡´
4. éµå®ˆåˆ†å±‚æ¶æ„ï¼Œé¿å…å¾ªç¯ä¾èµ–
5. ç¦æ­¢ä½¿ç”¨ emoji å’Œå›¾å½¢ç¬¦å·
6. ä½¿ç”¨ decimal å¤„ç†é‡‘é¢ï¼Œé¿å… float
7. æ‰€æœ‰å†™æ“ä½œæ”¯æŒå¹‚ç­‰æ€§
8. é€‚å½“ä½¿ç”¨ç¼“å­˜ä¼˜åŒ–æ€§èƒ½
