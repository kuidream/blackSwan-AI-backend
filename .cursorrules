# blackSwan AI Backend - Cursor Rules

## é¡¹ç›®æ¦‚è¿°

blackSwan æ˜¯ä¸€ä¸ªåŸºäºç°å®æ˜ å°„çš„è‡ªåŠ¨æ¼”è¿›å¼ RPG æ¸¸æˆåç«¯ç³»ç»Ÿï¼Œé‡‡ç”¨ Golang + PostgreSQL æŠ€æœ¯æ ˆã€‚

## æ ¸å¿ƒé“å¾‹ (Critical Rules)

### 1. æ•°æ®åº“é“å¾‹ (Database Schema - SSOT)

**å•ä¸€äº‹å®æ¥æº**: `.ai/database/schema.sql` æ˜¯æ•°æ®åº“ç»“æ„çš„å”¯ä¸€çœŸç†

**å¼ºåˆ¶è¦æ±‚**:
- ç”Ÿæˆä»»ä½• SQL æˆ– GORM æ¨¡å‹æ—¶ï¼Œå­—æ®µåã€ç±»å‹ã€çº¦æŸå¿…é¡»ä¸¥æ ¼åŒ¹é… `schema.sql`
- ä¸¥ç¦è‡†é€ å­—æ®µã€è¡¨åæˆ–ä¿®æ”¹æ•°æ®ç±»å‹
- è¡¨åä½¿ç”¨å•æ•°å½¢å¼ï¼ˆplayer, market_orderï¼‰
- å­—æ®µä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼ˆcreated_at, player_idï¼‰
- é‡‘é¢/æ•°é‡å­—æ®µå¿…é¡»ä½¿ç”¨ NUMERIC(30, 10)ï¼Œä¸¥ç¦ä½¿ç”¨ float
- æ‰€æœ‰ä¸»é”®ä½¿ç”¨ UUIDï¼Œé»˜è®¤å€¼ä¸º gen_random_uuid()
- æ—¶é—´æˆ³å­—æ®µä½¿ç”¨ TIMESTAMPTZï¼Œé»˜è®¤å€¼ä¸º now()

**Schema åŒæ­¥æœºåˆ¶**:
- ä¸¥ç¦é€šè¿‡ Navicat/DataGrip ç›´æ¥ä¿®æ”¹äº‘ç«¯æ•°æ®åº“ç»“æ„
- æ‰€æœ‰ç»“æ„å˜æ›´å¿…é¡»å…ˆä¿®æ”¹æœ¬åœ° `schema.sql`ï¼Œç„¶åé€šè¿‡ Atlas å·¥å…·æ¨é€
- ç¼–å†™ä»£ç æ—¶ï¼Œé»˜è®¤ schema.sql ä¸­çš„ç»“æ„å·²åŒæ­¥è‡³æ•°æ®åº“
- ä¸è¦ç¼–å†™ "CREATE TABLE IF NOT EXISTS" æ£€æŸ¥é€»è¾‘ï¼Œç›´æ¥ä½¿ç”¨å³å¯

**GORM æ¨¡å‹ç”Ÿæˆè§„åˆ™**:
```go
// æ­£ç¡®ç¤ºä¾‹ï¼šä¸¥æ ¼åŒ¹é… schema.sql
type Player struct {
    ID        uuid.UUID `gorm:"type:uuid;primaryKey;default:gen_random_uuid()"`
    Nickname  string    `gorm:"type:text;not null"`
    CreatedAt time.Time `gorm:"type:timestamptz;not null;default:now()"`
    UpdatedAt time.Time `gorm:"type:timestamptz;not null;default:now()"`
}

// é”™è¯¯ç¤ºä¾‹ï¼šä¸è¦è‡†é€ å­—æ®µ
type Player struct {
    ID       uuid.UUID
    Name     string    // é”™è¯¯ï¼šschema.sql ä¸­æ˜¯ nickname ä¸æ˜¯ name
    Email    string    // é”™è¯¯ï¼šschema.sql ä¸­æ²¡æœ‰ email å­—æ®µ
    Age      int       // é”™è¯¯ï¼šschema.sql ä¸­æ²¡æœ‰ age å­—æ®µ
}
```

### 2. æ¥å£é“å¾‹ (API Contract)

**å¥‘çº¦æ–‡æ¡£**: `.ai/api/api-reference.md` æ˜¯å¯¹å¤–æ‰¿è¯ºçš„ API å¥‘çº¦

**å¼ºåˆ¶è¦æ±‚**:
- ç”Ÿæˆçš„ Handler ä»£ç å¿…é¡»ä¸¥æ ¼éµå®ˆ Request/Response ç»“æ„
- ç»Ÿä¸€å“åº”æ ¼å¼å¿…é¡»åŒ…å« request_id, server_time, data/error
- æ‰€æœ‰å†™æ“ä½œå¿…é¡»æ”¯æŒ Idempotency-Key
- æ—¶é—´ä½¿ç”¨ Unix ç§’æˆ– RFC3339 (UTC)
- é‡‘é¢/æ•°é‡ä½¿ç”¨å­—ç¬¦ä¸²æˆ– decimalï¼Œé¿å… float
- Base URL å¿…é¡»ä»¥ /v1 å¼€å¤´

**Handler ç¤ºä¾‹**:
```go
// æ­£ç¡®ç¤ºä¾‹ï¼šä¸¥æ ¼éµå®ˆ API æ–‡æ¡£
type PlaceOrderRequest struct {
    Symbol         string `json:"symbol" binding:"required"`
    Side           string `json:"side" binding:"required,oneof=BUY SELL"`
    Type           string `json:"type" binding:"required,oneof=MARKET LIMIT"`
    Qty            string `json:"qty" binding:"required"`
    ClientOrderID  string `json:"client_order_id"`
}

type SuccessResponse struct {
    RequestID  string      `json:"request_id"`
    ServerTime int64       `json:"server_time"`
    Data       interface{} `json:"data"`
}

// é”™è¯¯ç¤ºä¾‹ï¼šä¸è¦è‡ªåˆ›å“åº”æ ¼å¼
type Response struct {
    Code    int         `json:"code"`     // é”™è¯¯ï¼šAPI æ–‡æ¡£ä¸­æ²¡æœ‰ code å­—æ®µ
    Message string      `json:"message"`  // é”™è¯¯ï¼šåº”è¯¥åœ¨ error å¯¹è±¡ä¸­
    Data    interface{} `json:"data"`
}
```

### 3. å·¥ç¨‹é“å¾‹ (Project Structure)

**ç»“æ„æ–‡æ¡£**: `project_structure.tree` å®šä¹‰äº†ä»£ç ç»„ç»‡æ–¹å¼

**å¼ºåˆ¶è¦æ±‚**:
- ä»£ç æ–‡ä»¶å¿…é¡»æ”¾ç½®åœ¨æ­£ç¡®çš„ç›®å½•å±‚çº§ä¸­
- ä¸¥æ ¼éµå®ˆåˆ†å±‚æ¶æ„ï¼šHandler â†’ Usecase â†’ Repository â†’ Domain
- ä¸¥ç¦å¾ªç¯å¼•ç”¨ï¼šService å±‚ä¸å¾—å¼•ç”¨ Controller/Handler å±‚
- Domain å±‚ä¸å¾—ä¾èµ–ä»»ä½•å¤–éƒ¨åŒ…ï¼ˆé™¤æ ‡å‡†åº“ï¼‰
- Repository å±‚åªèƒ½è¢« Usecase å±‚è°ƒç”¨

**ç›®å½•è§„èŒƒ**:
```
cmd/                    # åº”ç”¨å…¥å£
internal/
  â”œâ”€â”€ handler/         # HTTP/WebSocket å¤„ç†å™¨ï¼ˆä¾èµ– usecaseï¼‰
  â”œâ”€â”€ usecase/         # ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆä¾èµ– repository, domainï¼‰
  â”œâ”€â”€ repository/      # æ•°æ®è®¿é—®å±‚ï¼ˆä¾èµ– domainï¼‰
  â”œâ”€â”€ domain/          # é¢†åŸŸæ¨¡å‹ï¼ˆä¸ä¾èµ–å…¶ä»–å±‚ï¼‰
  â””â”€â”€ config/          # é…ç½®
pkg/                   # å…¬å…±åº“
```

**ä¾èµ–è§„åˆ™**:
```
æ­£ç¡®ï¼š
handler â†’ usecase â†’ repository â†’ domain
handler â†’ domain
usecase â†’ domain

é”™è¯¯ï¼š
usecase â†’ handler        âŒ å¾ªç¯ä¾èµ–
repository â†’ usecase     âŒ åå‘ä¾èµ–
domain â†’ repository      âŒ é¢†åŸŸæ¨¡å‹ä¸åº”ä¾èµ–åŸºç¡€è®¾æ–½
```

## ç¼–ç è§„èŒƒ

### å‘½åè§„èŒƒ

**ç¦æ­¢ä½¿ç”¨**:
- Emoji è¡¨æƒ…ï¼šğŸš€âœ…âŒğŸ’¡âš¡â­ğŸŒŸğŸ¨ğŸ”¥ğŸ‰
- å›¾å½¢ç¬¦å·ï¼šâ†’ â† â†‘ â†“ â˜… â˜† â—† â—‡ â— â—‹ â–  â–¡ â–² â–³
- ç‰¹æ®Šå­—ç¬¦ï¼šâ€» â˜… â˜† â™  â™£ â™¥ â™¦
- è¿‡åº¦è£…é¥°ï¼š=== --- ***

**æ­£ç¡®å‘½å**:
```go
// åŒ…å‘½åï¼šå°å†™å•è¯
package marketengine

// æ¥å£å‘½åï¼šI + åè¯
type IMarketService interface {}

// ç»“æ„ä½“ï¼šå¤§é©¼å³°
type MarketTick struct {}

// å‡½æ•°ï¼šå¤§é©¼å³°ï¼ˆå…¬å¼€ï¼‰/ å°é©¼å³°ï¼ˆç§æœ‰ï¼‰
func CalculatePrice() {}
func calculateDelta() {}

// å˜é‡ï¼šå°é©¼å³°
var playerBalance int64

// å¸¸é‡ï¼šå¤§é©¼å³°æˆ–å…¨å¤§å†™
const MaxDailySteps = 20000
```

### æ³¨é‡Šè§„èŒƒ

```go
// æ­£ç¡®ï¼šç®€æ´å®ç”¨
// CalculateSourceReward è®¡ç®—æºç‚¹å¥–åŠ±
// åŸºäº IoT æ•°æ®å’Œå½“æ—¥é£æ ¼é…ç½®è®¡ç®—ç©å®¶å¯è·å¾—çš„æºç‚¹æ•°é‡
func CalculateSourceReward(steps int, styleConfig *StyleConfig) (int64, error) {
    // å®ç°é€»è¾‘
}

// é”™è¯¯ï¼šä½¿ç”¨ emoji æˆ–è¿‡åº¦è£…é¥°
// ğŸš€ CalculateSourceReward è®¡ç®—æºç‚¹å¥–åŠ±
// ================================
// â˜…â˜…â˜… é‡è¦å‡½æ•° â˜…â˜…â˜…
// ================================
```

### é”™è¯¯å¤„ç†

```go
// æ­£ç¡®ï¼šæ ‡å‡†é”™è¯¯å¤„ç†
if err != nil {
    return nil, fmt.Errorf("failed to calculate reward: %w", err)
}

// å®šä¹‰ä¸šåŠ¡é”™è¯¯
var (
    ErrInsufficientBalance = errors.New("insufficient balance")
    ErrInvalidPrice = errors.New("invalid price")
)
```

### æ—¥å¿—è§„èŒƒ

```go
// æ­£ç¡®ï¼šç»“æ„åŒ–æ—¥å¿—ï¼Œæ—  emoji
log.Info("order placed successfully",
    "order_id", orderId,
    "player_id", playerId,
    "symbol", "AERA",
)

// é”™è¯¯ï¼šä½¿ç”¨ emoji
log.Info("âœ… è®¢å•æˆåŠŸ")  // âŒ ç¦æ­¢
```

## æ•°æ®åº“æ“ä½œè§„èŒƒ

### ä½¿ç”¨ GORM

```go
// æ­£ç¡®ï¼šä½¿ç”¨äº‹åŠ¡å’Œé”™è¯¯å¤„ç†
func (r *OrderRepository) CreateOrder(order *Order) error {
    return r.db.Transaction(func(tx *gorm.DB) error {
        // 1. åˆ›å»ºè®¢å•
        if err := tx.Create(order).Error; err != nil {
            return fmt.Errorf("failed to create order: %w", err)
        }
        
        // 2. æ›´æ–°ä½™é¢
        if err := tx.Model(&PlayerBalance{}).
            Where("player_id = ? AND asset = ?", order.PlayerID, "SOURCE").
            Update("available_amount", gorm.Expr("available_amount - ?", order.TotalCost)).
            Error; err != nil {
            return fmt.Errorf("failed to update balance: %w", err)
        }
        
        return nil
    })
}

// é”™è¯¯ï¼šä¸ä½¿ç”¨äº‹åŠ¡ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
func (r *OrderRepository) CreateOrder(order *Order) error {
    r.db.Create(order)  // âŒ æ²¡æœ‰é”™è¯¯å¤„ç†
    r.db.Model(&PlayerBalance{}).Update(...)  // âŒ ä¸åœ¨åŒä¸€äº‹åŠ¡ä¸­
    return nil
}
```

### é‡‘é¢å­—æ®µå¤„ç†

```go
// æ­£ç¡®ï¼šä½¿ç”¨ decimal åŒ…
import "github.com/shopspring/decimal"

type Order struct {
    RequestedQty decimal.Decimal `gorm:"type:numeric(30,10)"`
    AvgPrice     decimal.Decimal `gorm:"type:numeric(30,10)"`
}

// è®¡ç®—
totalCost := order.RequestedQty.Mul(order.AvgPrice)

// é”™è¯¯ï¼šä½¿ç”¨ float
type Order struct {
    RequestedQty float64  // âŒ ç²¾åº¦é—®é¢˜
    AvgPrice     float64  // âŒ ç²¾åº¦é—®é¢˜
}
```

## API å¼€å‘è§„èŒƒ

### å¹‚ç­‰æ€§

```go
// æ­£ç¡®ï¼šæ”¯æŒå¹‚ç­‰æ€§
func (h *OrderHandler) PlaceOrder(c *gin.Context) {
    idempotencyKey := c.GetHeader("Idempotency-Key")
    if idempotencyKey == "" {
        c.JSON(400, ErrorResponse{Error: "Idempotency-Key is required"})
        return
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    existing, _ := h.orderService.GetByIdempotency(playerID, idempotencyKey)
    if existing != nil {
        c.JSON(200, SuccessResponse{Data: existing})
        return
    }
    
    // åˆ›å»ºæ–°è®¢å•
    order, err := h.orderService.PlaceOrder(req)
    // ...
}
```

### ç»Ÿä¸€å“åº”æ ¼å¼

```go
type SuccessResponse struct {
    RequestID  string      `json:"request_id"`
    ServerTime int64       `json:"server_time"`
    Data       interface{} `json:"data"`
}

type ErrorResponse struct {
    RequestID  string       `json:"request_id"`
    ServerTime int64        `json:"server_time"`
    Error      ErrorDetail  `json:"error"`
}

type ErrorDetail struct {
    Code    string      `json:"code"`
    Message string      `json:"message"`
    Details interface{} `json:"details,omitempty"`
}
```

## æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“æŸ¥è¯¢

```go
// æ­£ç¡®ï¼šä½¿ç”¨ç´¢å¼•å­—æ®µæŸ¥è¯¢
db.Where("player_id = ? AND created_at > ?", playerID, startTime).Find(&orders)

// æ­£ç¡®ï¼šé¢„åŠ è½½å…³è”æ•°æ®
db.Preload("Player").Preload("Position").Find(&orders)

// é”™è¯¯ï¼šN+1 æŸ¥è¯¢é—®é¢˜
for _, order := range orders {
    db.First(&player, order.PlayerID)  // âŒ å¾ªç¯æŸ¥è¯¢
}
```

### Redis ç¼“å­˜

```go
// æ­£ç¡®ï¼šä½¿ç”¨ç¼“å­˜
func (s *WorldService) GetTodayStyle() (*StyleConfig, error) {
    date := time.Now().Format("2006-01-02")
    key := fmt.Sprintf("world:style:%s", date)
    
    // å°è¯•ä»ç¼“å­˜è¯»å–
    cached, err := s.cache.Get(ctx, key).Result()
    if err == nil {
        return ParseStyleConfig(cached), nil
    }
    
    // ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“è¯»å–
    config, err := s.repo.GetStyleByDate(date)
    if err != nil {
        return nil, err
    }
    
    // å†™å…¥ç¼“å­˜
    s.cache.Set(ctx, key, config.ToJSON(), 24*time.Hour)
    return config, nil
}
```

## Git æäº¤è§„èŒƒ

```bash
# æ ¼å¼: <type>: <subject>

# æ­£ç¡®ç¤ºä¾‹
feat: æ·»åŠ  IoT æ•°æ®åŒæ­¥æ¥å£
fix: ä¿®å¤è¡Œæƒ…æ¨é€å»¶è¿Ÿé—®é¢˜
docs: æ›´æ–° API æ–‡æ¡£
refactor: é‡æ„è®¢å•æ’®åˆé€»è¾‘
perf: ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½

# é”™è¯¯ç¤ºä¾‹ï¼ˆä½¿ç”¨ emojiï¼‰
âœ¨ feat: æ·»åŠ æ–°åŠŸèƒ½  # âŒ ç¦æ­¢
ğŸš€ ä¼˜åŒ–æ€§èƒ½        # âŒ ç¦æ­¢
```

## æµ‹è¯•è§„èŒƒ

```go
// æ­£ç¡®ï¼šè¡¨é©±åŠ¨æµ‹è¯•
func TestCalculateSourceReward(t *testing.T) {
    tests := []struct {
        name     string
        steps    int
        expected int64
        wantErr  bool
    }{
        {"æ­£å¸¸æ­¥æ•°", 1000, 100, false},
        {"è¶…è¿‡ä¸Šé™", 25000, 2000, false},
        {"è´Ÿæ•°æ­¥æ•°", -100, 0, true},
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            got, err := CalculateSourceReward(tt.steps)
            if (err != nil) != tt.wantErr {
                t.Errorf("CalculateSourceReward() error = %v, wantErr %v", err, tt.wantErr)
                return
            }
            if got != tt.expected {
                t.Errorf("CalculateSourceReward() = %v, want %v", got, tt.expected)
            }
        })
    }
}
```

## å‚è€ƒæ–‡æ¡£

- æ ¸å¿ƒæ¶æ„ï¼š`.ai/docs/01-architecture.md`
- ä¸–ç•Œè§‚è®¾å®šï¼š`.ai/docs/02-world-setting.md`
- API å‚è€ƒï¼š`.ai/api/api-reference.md`
- æ•°æ®åº“ Schemaï¼š`.ai/database/schema.sql`
- å¼€å‘è§„èŒƒï¼š`.ai/README.md`

## é‡è¦æé†’

1. åœ¨ç¼–å†™ä»£ç å‰ï¼Œå…ˆé˜…è¯»ç›¸å…³æ–‡æ¡£ç¡®ä¿ç†è§£ä¸šåŠ¡é€»è¾‘
2. æ•°æ®åº“å­—æ®µå¿…é¡»ä¸ schema.sql å®Œå…¨ä¸€è‡´
3. API æ¥å£å¿…é¡»ä¸ api-reference.md å®Œå…¨ä¸€è‡´
4. éµå®ˆåˆ†å±‚æ¶æ„ï¼Œé¿å…å¾ªç¯ä¾èµ–
5. ç¦æ­¢ä½¿ç”¨ emoji å’Œå›¾å½¢ç¬¦å·
6. ä½¿ç”¨ decimal å¤„ç†é‡‘é¢ï¼Œé¿å… float
7. æ‰€æœ‰å†™æ“ä½œæ”¯æŒå¹‚ç­‰æ€§
8. é€‚å½“ä½¿ç”¨ç¼“å­˜ä¼˜åŒ–æ€§èƒ½
