## 1. 模块概述 (System Overview)
本模块负责里世界 (TripX) 的核心玩法：**在被操控的行情中博弈**。

+ **服务端 (Go):** 运行 `Ticker Engine`，根据算法实时广播 P_t（价格）。
+ **客户端 (Unity):** 绘制动态 K 线，处理 T+0 交易请求，计算浮动盈亏。
+ **数据流:** WebSocket 全双工通信。

---

## 2. 交易规则定义 (Trading Rules)
为了模拟“高频末日金融”，规则与现实股市有差异。

### 2.1 基础机制
+ **交易标的:** AERA (游戏内唯一的超级公司股票) 或其衍生 ETF。
+ **交易时间:** 游戏内时间 09:30 - 15:00 (中间无休)。
+ **交易机制:****T+0** (即买即卖)。
+ **涨跌幅:****无限制** (方便制造 50% 的暴跌)。
+ **手续费:**
    - 买入: 0%
    - 卖出: **0.1%** (以源点结算，若源点不足则从成交额中扣除)。

### 2.2 订单类型 (Order Types)
为了简化操作，只提供两种订单：

1. **市价单 (Market Order):**
    - _定义:_ 立即以当前最优价成交。
    - _滑点 (Slippage):_ 正常行情 0.1%，暴跌行情(黑天鹅)下扩大至 **5%~10%**（模拟流动性枯竭）。
2. **技能单 (Skill Order):**
    - _定义:_ 消耗源点发动的特殊操作（如“熔断”）。

---

## 3. 行情演算引擎详细设计
这是后端 Go 服务的核心逻辑。

### 3.1 价格广播协议 (WebSocket)
服务端每 **200ms** 推送一次 Tick 数据包。

```plain
// S2C_MarketTick
{
  "symbol": "AERA",
  "timestamp": 1738029283,
  "price": 124.56,
  "volume": 5000,
  "trend_flag": -1, // -1:暴跌中(触发UI红光), 0:正常, 1:暴涨
  "delta_debug": { // 仅开发期可见，用于调试算法
    "burst_weight": 0.02,
    "anti_luck_factor": -0.05
  }
}
```

### 3.2 扰动因子算法实现 (The Delta Logic)
对应 Doc 5 中的 δₜ。

#### A. 爆仓吸引 (δ_burst)
+ **触发逻辑:**
    1. 遍历在线玩家持仓。
    2. 计算 **加权平均爆仓价 (Weighted Liquidation Price)**。
    3. 若 `(当前价 - 平均爆仓价) / 当前价 < 0.05` (距离 5%)。
    4. **生效:** 施加一个指向爆仓价的引力向量。
+ **数值配置:** 引力系数不宜过大，要让价格呈现“磨蹭、试探”的感觉，最大程度消耗玩家 San 值。

#### B. 连胜惩罚 (δ_antiLuck)
+ **判定:** 玩家最近 5 笔交易 **胜率 > 80%** 且 **盈利 > 总资产 20%**。
+ **生效:**
    - 玩家买入瞬间 -> 施加 **-0.5%** 的瞬时滑点。
    - 持仓期间 -> 波动率噪音 (ηₜ) 放大 1.5 倍（更容易被震仓出局）。

#### C. 黑天鹅事件 (**δ_blackSwan**)
+ **触发:** 根据 `Cfg_Market_Event` 表。
+ **表现:** 连续 10 个 Tick 都是单边下跌，且**拒绝成交**（模拟拔网线）。
+ **解除:** 持续时间结束，或全服玩家投入的“熔断技能”总量达标。

---

## 4. 配表结构需求
### 4.1 `Cfg_Stock_Market.xlsx` (市场参数表)
定义不同风格下的市场基础参数。

| **Style_ID** | **Base_Volatility (基础波动率)** | **Volume_Multiplier (成交量倍率)** | **Slippage_Rate (基础滑点)** | **Desc** |
| --- | --- | --- | --- | --- |
| Xianxia | 0.02 (平稳) | 1.0 | 0.05% | 修仙日：古波不惊，适合养生 |
| Cyber | 0.05 (剧烈) | 2.5 (高频) | 0.2% | 赛博日：量化收割，上下插针 |
| Doom | 0.08 (极度) | 0.1 (枯竭) | 5.0% | 末日日：流动性归零，买卖极难 |


### 4.2 `Cfg_Intel_Shop.xlsx` (情报/技能表)
定义源点可以购买的“外挂”。

| **ID** | **Name_Key** | **Cost_Source** | **Effect_Type** | **Effect_Params** | **CD_GameTime** | **Icon** |
| --- | --- | --- | --- | --- | --- | --- |
| 1 | 盘前内参 | 100 | SHOW_RANGE | Range=0.8 (显示80%置信区间) | 1 Day | `Icon_Paper` |
| 2 | 资金透视 | 500 | SHOW_WHALE | Depth=3 (显示3档主力单) | 60 Min | `Icon_Eye` |
| 3 | 紧急熔断 | 1000 | FREEZE_MARKET | Duration=30s (停牌30秒) | 1 Day | `Icon_Stop` |


### 4.3 `Cfg_Market_Event.xlsx` (黑天鹅事件表)
定义突发利空/利好。

| **ID** | **Style_Tag** | **Type** | **Probability** | **Impact_Delta (跌幅)** | **Duration (秒)** | **News_Template_Key** |
| --- | --- | --- | --- | --- | --- | --- |
| 901 | Cyber | CRASH | 0.05 | -0.3 (跌30%) | 60 | NEWS_CYBER_HACK |
| 902 | Xianxia | BOOM | 0.02 | +0.5 (涨50%) | 120 | NEWS_XIANXIA_ASCEND |


---

## 5. UI/UX 交互详细设计
### 5.1 K 线图表控件 (K-Line Chart)
+ **基础功能:** 支持 M1 (分时), M15, H1 切换。
+ **特殊渲染:**
    - **San 值低时:** K 线出现**重影 (Ghosting)** 和 **色差故障 (Glitch)**。
    - **黑天鹅时:** 整个图表背景泛红，K 线变成类似“触手”或“闪电”的扭曲形状。

### 5.2 下单面板 (Order Panel)
+ **极简设计:** 只有 `BUY` (绿/蓝) 和 `SELL` (红)。
+ **长按机制:**
    - 为了增加紧张感，大额交易需要 **长按 1 秒** 确认。
    - 长按期间，手机马达跟随心跳频率震动（调用 Taptic Engine）。

### 5.3 情报终端 (Intel Terminal)
+ **入口:** K 线图右上角的“一只眼睛”图标。
+ **交互:**
    1. 点击图标 -> 弹出雷达扫描动画。
    2. 扣除源点 -> 动画定格，生成一份“机密文件”UI。
    3. **视觉化展示:** 不只是文字，直接在 K 线图上画出一条**虚线**（预测轨迹）。

### 5.4 浮亏反馈 (Panic Feedback)
当 `Floating PnL < -10%` 时：

1. **视觉:** 屏幕边缘出现暗角 (Vignette) 和血丝。
2. **听觉:** 背景白噪音 (空调声/电流声) 变大，盖过 BGM。
3. **触觉:** 每次价格下跌 Tick，手机轻微震动一下。

