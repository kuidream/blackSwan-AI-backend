## 1. 模块概述
本模块负责 **文本流 (Text Stream)** 的处理。

+ **输入:** 每日随机抽取的原始小说片段 (`Raw_Text`) + 实时游戏数据 (`Game_State`)。
+ **核心:** LLM (大语言模型) + Prompt 模板库。
+ **输出:**
    1. **全局配置 (JSON):** 每日 UI 主题色、IoT 动作重命名。
    2. **情报文案 (String):** 带有风格滤镜和 San 值扭曲的金融新闻。

---

## 2. 每日演进流程 (Global Evolution)
**执行频率:** 每日 00:00 (服务端定时任务)。

**消耗:** 低 (每日 1 次调用)。

### 2.1 风格生成 Prompt (The Architect)
该 Prompt 负责“读小说”，并提取出游戏的“今日规则”。

```plain
# System Prompt: Game_World_Architect
# Role: 
你是一个沉浸式游戏的“世界观架构师”。

# Input:
今日原始文本: {{raw_text_chunk}} (约 500 字)

# Task:
1. 分析文本的题材风格 (武侠/赛博/末日/克苏鲁/都市)。
2. 提取文本中的核心名词，替换游戏内的 IoT 术语。
3. 生成一组 UI 配色方案 (Hex Code)。

# Constraints:
- 输出必须为标准 JSON 格式。
- "steps_action" (跑步) 必须是动词短语 (如: 御剑)。
- "sanity_name" (理智) 必须符合风格 (如: 道心/算力/San值)。

# Output JSON Structure:
{
  "style_tag": "Xianxia",
  "theme_color_primary": "#E0FFFF", // 主色调
  "theme_color_warning": "#FF4500", // 暴跌/警告色
  "currency_name": "灵石", // 替换“源点”显示的名称
  "iot_mapping": {
    "run": {"name": "神行", "desc": "消耗体力，积累天地灵气"},
    "sleep": {"name": "闭关", "desc": "稳固境界"}
  },
  "market_terms": {
    "bull": "飞升", // 牛市
    "bear": "天劫", // 熊市
    "crash": "道崩" // 崩盘
  }
}
```

### 2.2 容错机制 
_如果 LLM API 超时或返回非 JSON 格式：_

+ **机制:** 后端捕获异常，自动加载本地默认配置 (`Default_Cyberpunk.json`)。
+ **日志:** 记录 Error Log，但不影响玩家登录。

---

## 3. 实时情报渲染 (Real-time Intel)
**执行频率:** 玩家付费点击“购买情报”时。

**消耗:** 中 (单人日均 < 10 次)。

### 3.1 动态文案 Prompt (The Narrator)
该 Prompt 负责“说黑话”。它需要结合**风格**和**玩家当前的 San 值**。

```plain
# System Prompt: TripX_Narrator
# Role: 
你是一个跨维度的金融终端 AI。

# Context:
- 当前风格: {{current_style}} (例如: 克苏鲁)
- 玩家 San 值: {{user_sanity}} (0-100)
- 市场事件: {{market_event}} (例如: AERA 股价即将下跌 15%)

# Task:
生成一条简短的快讯 (30字以内)。

# Rules:
1. 若 San 值 > 60: 语言逻辑清晰，带有风格隐喻。
   - 例: "星辰的位置不对，深渊正在凝视 AERA 的股价。"
2. 若 San 值 < 30: 语言破碎，充满恐惧、乱码和幻觉。
   - 例: "不要看！K线变成了触手... 它们在吃... 15%... 逃..."

# Output:
(直接输出纯文本，无需 JSON)
```

### 3.2 幻觉注入 (Hallucination Injection)
为了节省 Token，部分简单的“乱码效果”不需要 LLM 生成，而是由**客户端着色器 (Shader)** 或 **字符串处理函数** 完成。

+ **客户端后处理 (C#):**

```plain
string ProcessText(string rawText, float sanity) {
    if (sanity > 50) return rawText;

    // San值低时，随机插入乱码字符
    char[] glitchChars = {'#', '?', '§', 'µ', 'ø'};
    // 算法：每隔 N 个字符替换一个乱码
    return GlitchAlgorithm.Apply(rawText, intensity: (100 - sanity));
}
```

---

## 4. 安全与风控 (Safety & Compliance)
既然接入了 LLM，就必须防止 AI 生成敏感内容（政治、色情、暴力）。

### 4.1 输入侧防御 (Input Shield)
+ **语料库清洗:**`Raw_Data` 中的小说文本必须经过人工或脚本审核，确保不包含违规内容。

### 4.2 输出侧过滤 (Output Shield)
+ **关键词黑名单 (Blocklist):**
    - 在 Go 服务端维护一个 `sensitive_words.txt`。
    - LLM 返回的文本若包含黑名单词汇，直接**丢弃**，并返回兜底文案（如：“[数据流受损，无法解析]”）。
+ **长度截断:** 限制 LLM 输出 `max_tokens = 60`，防止 AI 废话连篇或“写小说”。

---

## 5. 配表结构需求
### 5.1 `Cfg_Style_Corpus.xlsx` (语料库表)
定义 AI 每天读什么。

| **ID** | **Style_Tag** | **Text_Content (TextChunk)** | **Weight (抽取权重)** |
| --- | --- | --- | --- |
| 1 | Xianxia | "韩立眉头一皱，退至众人身后..." | 10 |
| 2 | Cyber | "霓虹灯在积水中倒映出破碎的代码..." | 10 |
| 3 | Cthulhu | "那不可名状的几何体在疯狂旋转..." | 5 (稀有) |


### 5.2 `Cfg_Prompt_Template.xlsx` (提示词表)
定义系统 Prompt，方便策划热更新调整 AI 人格。

| **ID** | **Function_Type** | **System_Prompt_Text** | **Max_Tokens** | **Temperature** |
| --- | --- | --- | --- | --- |
| 1 | Daily_Gen | "你是一个沉浸式游戏的..." | 500 | 0.7 |
| 2 | Intel_News | "你是一个跨维度的金融终端..." | 100 | 1.2 (高创造性) |


---

## 6. 系统流程图
```plain
graph TD
    subgraph "Server Side (Golang)"
        Cron[00:00 定时任务] -->|1. 读取语料| DB[(PostgreSQL)]
        Cron -->|2. 组装 Prompt| LLM[LLM API]
        LLM -->|3. 返回 JSON| Validator{格式校验}
        
        Validator -->|通过| Redis[今日全局配置]
        Validator -->|失败| LocalConfig[加载兜底配置]
    end
    
    subgraph "Client Side (Unity)"
        User[玩家购买情报] -->|4. Request| ServerAPI
        ServerAPI -->|5. 组装 San值 + 趋势| LLM
        LLM -->|6. 返回文案| Filter{敏感词过滤}
        Filter -->|7. 下发| UI[情报弹窗]
    end
```

---

## 7. 成本控制
为了防止 LLM 费用爆炸：

1. **模型分级:**
    - **每日风格 (Global):** 使用 **GPT-4o** 或 **Claude 3.5 Sonnet** (高质量，每天只调一次，贵点没事)。
    - **实时情报 (User):** 使用 **GPT-4o-mini** 或 **Claude 3 Haiku** (极速、便宜)。
2. **缓存策略:**
    - 对于同一风格、同一涨跌趋势的“情报”，可以缓存 10 分钟。
    - _例:_ 10:00 到 10:10 之间，所有买“利空消息”的玩家，看到的都是同一条 AI 生成的文案。
3. **每日限额:**
    - 每个玩家每日最多调用 20 次实时生成。超过后使用本地预设文案库。

