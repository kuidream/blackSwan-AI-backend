## 1. 模块概述
本模块负责处理从 **物理世界 (Physical Layer)** 到 **表世界 (Surface Layer)** 的所有数据交互。

+ **输入:** 智能设备（Apple Watch / Huawei / Android Wear）的三项基础数据：步数、心率、睡眠。
+ **处理:** 经过 **[主神风格滤镜]** 的包装与 **[防作弊校验]**。
+ **输出:** 玩家账户中的 **源点 (Source)** 增加。

---

## 2. 数据标准与采集规则
**不使用 MQTT 直连，而是采用“Native Bridge (原生桥接)”模式（mqtt太费电了）。**

```plain
graph TD
    subgraph "Hardware Layer (The Chaos)"
        AppleWatch
        MiBand[小米手环]
        HuaweiWatch
        Garmin
    end

    subgraph "OS Aggregation Layer (The Hub)"
        AppleWatch -->|BLE| iOS_HealthKit[iOS HealthKit]
        MiBand -->|App Sync| iOS_HealthKit
        MiBand -->|App Sync| Android_Health[Android Health Connect]
        HuaweiWatch -->|App Sync| Android_Health
    end

    subgraph "Unity Client (Your Game)"
        iOS_HealthKit -->|Native Plugin| UnityC#[Unity C# Logic]
        Android_Health -->|Native Plugin| UnityC#
    end

    UnityC# -->|HTTPS/JSON| GolangServer[Golang Backend]
```



### 2.1 核心数据定义
| **数据类型** | **数据源 (SDK Key)** | **采集频率** | **有效性阈值 (Valid Range)** | **说明** |
| --- | --- | --- | --- | --- |
| **步数 (Steps)** | `step_count` | 每次启动/切回前台 | 0 ~ 100,000 /日 | 超过 10万步/日 标记为异常数据。 |
| **心率 (HR)** | `heart_rate.avg` | 每 10 分钟采样一次 | 40 ~ 220 bpm | 用于判定“冥想”或“爆发”状态。 |
| **睡眠 (Sleep)** | `sleep.duration` | 每日 08:00 后结算 | 0 ~ 24 小时 | 需包含 `deep_sleep`<br/> (深睡) 字段以计算暴击。 |


### 2.2 数据同步逻辑
1. **冷启动/前台激活:** App 检查上次同步时间戳 (`Last_Sync_Time`)。
2. **增量获取:** 调用 SDK (HealthKit/GoogleFit) 获取 `Last_Sync_Time` 到 `Now` 之间的新增数据。
3. **本地缓存:** 客户端本地暂存，等待玩家点击“提取”或自动上传。

---

## 3. 资源产出公式 
源点是游戏内的**现金本金**。产出公式必须严格控制通胀，同时保证玩家有动力去运动。

### 3.1 基础产出 (Base Yield)
产出源点 = (新增数据值 X 转化率) + 额外奖励

+ **步数转化:**`10 步 = 1 源点`
    - _例:_ 跑 5 公里（约 7000 步） = 700 源点（初始本金）。
+ **日上限:** 每日步数奖励上限 2000 源点（防止摇步器刷钱）。

### 3.2 风格化加成
根据每日 00:00 生成的 `Daily_Style_Config`，特定行为会有加成。

| **今日风格** | **加成行为** | **判定条件** | **加成系数 (Multiplier)** |
| --- | --- | --- | --- |
| **修仙 (Xianxia)** | **静息 (Meditation)** | 任意连续 30分钟的心率 < 70 bpm | 额外 +300 源点 (每日限1次) |
| **赛博 (Cyber)** | **充能 (Charge)** | 睡眠时长 > 7 小时 | 结算系数 1.5x (睡眠奖励翻倍) |
| **末日 (Doom)** | **逃生 (Sprint)** | 任意 10分钟内步频 > 160 | 额外 +200 源点 (每日限3次) |


### 3.3 防作弊风控 (Anti-Cheat)
后端 `IoT_Validator` 服务需执行以下检查：

1. **速度物理墙:** 如果 `(NewSteps - OldSteps) / TimeDelta > 5步/秒` 且持续超过 1 分钟 -> **判定为摇步器**，该段数据无效。
2. **时间旅行者:** 上传的时间戳晚于服务器当前时间 -> **拒绝同步**。
3. **重复哈希:** 相同的数据包 Hash 被重复提交 -> **丢弃**。

---

## 4. 流程图
```plain
sequenceDiagram
    participant Device as 智能手表/手机SDK
    participant Client as Unity客户端
    participant Server as Golang后端
    participant DB as 数据库(PostgreSQL)

    Note over Client: 玩家点击“提取能量”

    Client->>Device: 1. Request Incremental Data (Since LastSync)
    Device-->>Client: 2. Return JSON {steps: 5000, hr: 80, ...}
    
    Client->>Client: 3. Pre-process (格式化)
    
    Client->>Server: 4. API: /api/iot/sync (Payload + Signature)
    
    Note over Server: 5. 防作弊校验 (速率/时间戳)
    
    alt 校验通过
        Server->>Server: 6. 读取今日风格配置 (Redis)
        Server->>Server: 7. 计算源点 = steps*rate * style_bonus
        Server->>DB: 8. Update User_Wallet (+500 Source)
        Server-->>Client: 9. Success {added: 500, total: 1500}
    else 校验失败
        Server-->>Client: 9. Error {code: 1001, msg: "异常数据"}
    end
    
    Client->>Client: 10. 播放“能量入账”动画
```

---

## 5. 配表需求预览 
我们需要以下两张核心配表来驱动这个系统。

### 5.1 `Cfg_IoT_Mapping.xlsx` (行为映射表)
这张表决定了不同风格下，UI 显示什么文案。

| **ID** | **Style_Tag** | **Action_Type** | **Name_Key** | **Desc_Key** | **Icon_Path** |
| --- | --- | --- | --- | --- | --- |
| 101 | Xianxia | Steps | 缩地成寸 | 积攒脚力，转化灵气 | `Img/Icon/Sword_Fly` |
| 102 | Xianxia | Sleep | 闭关打坐 | 稳固元神，恢复道心 | `Img/Icon/Sit_Down` |
| 201 | Cyber | Steps | 数据运送 | 躲避防火墙扫描 | `Img/Icon/Cyber_Run` |
| 202 | Cyber | Sleep | 系统维护 | 挂机清理缓存 | `Img/Icon/Cyber_Sleep` |


### 5.2 `Cfg_IoT_Reward.xlsx` (数值奖励表)
这张表决定了具体给多少钱。

| **ID** | **Action_Type** | **Base_Rate (每单位奖励)** | **Daily_Cap (日上限)** | **Trigger_Threshold (最小触发值)** |
| --- | --- | --- | --- | --- |
| 1 | Steps | 0.1 (每步0.1源点) | 2000 | 100 (少于100步不结算) |
| 2 | Sleep_Light | 50 (每小时) | 400 | 1 (小时) |
| 3 | Sleep_Deep | 100 (每小时) | 800 | 0.5 (小时) |


---

## 6. UI/UX 交互逻辑
### 6.1 主界面仪表盘 (Main Dashboard)
+ **状态:** 默认显示今日风格背景（如修仙风）。
+ **控件:** 一个巨大的圆环进度条，显示今日步数/目标。
+ **文案:** 不显示 "5000 步"，而是显示 **"今日行军：5000 里"** (读取 `Cfg_IoT_Mapping`)。

### 6.2 提取反馈 (Feedback)
+ **操作:** 玩家点击圆环中心的“提取”按钮。
+ **动画:**
    1. 数字滚动：步数减少，源点增加。
    2. 粒子特效：从圆环吸入能量到右上角的钱包。
    3. **暴击提示:** 如果触发了风格加成（如修仙日心率很低），弹出特殊提示框：
        * _“检测到道友心如止水，触发【冥想】加成！额外获得 300 源点！”_

### 6.3 异常处理
+ **未授权:** 显示“未连接终端”，引导去系统设置开权限。
+ **作弊拦截:** 弹出红字警告：“检测到时空扰动（数据异常），本次提取失败，请勿使用物理外挂。”

