## 1. 模块概述
San 值（Sanity）是玩家在里世界 (TripX) 的 **“心理保证金”**。

+ **定义:** 它是限制玩家杠杆率和持仓时间的核心资源。
+ **核心循环:** 亏损/黑天鹅 —— San 值下降 —— 产生幻觉/操作变形 —— 更加亏损 —— 心态崩盘 (Game Over)。
+ **数值范围:** 0.0 ~ 100.0 (浮点数)。

---

## 2. San 值演算逻辑
San 值的变化是实时计算的，分为 **被动压力 (Passive)** 和 **主动恢复 (Active)**。

### 2.1 被动压力公式
当玩家持仓出现**浮亏 (Floating Loss)** 时，San 值会随时间流逝而扣除。亏得越多，掉得越快（指数级）。

$ San_{drop} = \Delta t \times K_{style} \times (Loss \times 10)^2
 $

+ $ \Delta t $**:** 时间增量（秒）。     
+ $ K_{style} $**:** 今日风格压力系数（由 `Daily_Config` 决定）。
    - _修仙日:_ 0.8 (心态平和，掉得慢)。
    - _末日日:_ 1.5 (环境压抑，掉得快)。
+ **浮亏百分比:**`(现价 - 均价) / 均价`。
    - _例:_ 亏损 10% (0.1)，平方后为 0.01。
    - _例:_ 亏损 30% (0.3)，平方后为 0.09。**压力是亏 10% 时的 9 倍！**

### 2.2 事件冲击 (Event Shock)
某些瞬间事件会直接扣除固定数值的 San 值。

+ **黑天鹅爆发:** 瞬间 -20。
+ **女主拒绝/冷战:** 瞬间 -30。
+ **踏空 (卖飞了):** 瞬间 -10 (懊悔值)。

### 2.3 恢复途径 (Recovery)
San 值**不会自动恢复**（除非空仓）。必须通过行动恢复：

1. **现实睡眠 (IoT):** 昨晚深睡 2 小时 —— 今日进游戏 San 值上限 +20。
2. **空仓休息 (Rest):** 不持有任何股票时，每分钟恢复 5 点。
3. **药物/消费 (Items):** 消耗源点购买“镇静剂”或“去酒吧喝酒”。

---

## 3. 精神状态阶段 (Mental States)
根据 San 值剩余量，客户端会进入不同状态，影响 UI 和操作。

| **状态 (State)** | **San 值区间** | **UI 表现 (Visuals)** | **操作惩罚 (Gameplay Impact)** |
| --- | --- | --- | --- |
| **理智 (Lucid)** | 80 ~ 100 | 清晰、锐利 | 无。操作响应速度 100%。 |
| **焦虑 (Anxious)** | 40 ~ 79 | 边缘轻微暗角，BGM 混入低频噪音 | **情报模糊:** 购买的“内幕消息”有 20% 几率出现乱码。 |
| **恐慌 (Panic)** | 10 ~ 39 | 屏幕剧烈呼吸动效，K 线出现重影 (Ghosting) | **操作变形:**<br/>   <br/>1. 买/卖按钮位置每 5 秒随机互换。<br/>   <br/>2. 下单时长按确认时间从 1s 延长至 3s (手抖)。 |
| **崩盘 (Breakdown)** | 0 ~ 9 | 全屏血红，耳鸣声盖过一切 | **AI 接管 (强制平仓):**<br/>   <br/>触发 `Force_Liquidation` 流程。 |


---

## 4. 强制机制：心态崩盘 (The Breakdown)
当 San 值归零，玩家角色**失去理智**。

### 4.1 触发流程
1. **输入锁定:** 玩家无法进行任何操作，UI 按钮全部禁用。
2. **自动演出:**
    - 屏幕中央弹出巨大的红色文字：**"MENTAL BREAKDOWN"**。
    - 角色独白（自动播放）：_"受不了了... 让它停下来... 全都卖掉！"_
3. **强制平仓:** 系统以**市价 (Market Price)** 卖出账户内所有 AERA 股票。
    - _注: 市价卖出通常会吃到巨大的滑点，导致资产大幅缩水。_
4. **强制跳转:**
    - 当前**时间槽**直接结束。
    - 场景强制切换至 **【酒吧 (The Bar)】** 或 **【医院】**。
    - 扣除 **500 源点**（医药费/酒水费）。
    - _如果源点不足，则背负债务（负债状态）。_

---

## 5. 配表结构需求
### 5.1 `Cfg_Sanity_State.xlsx` (状态阈值表)
定义不同阶段的阈值和效果。

| **State_ID** | **Name** | **Min_Value** | **Max_Value** | **UI_Effect_Prefab** | **Input_Delay (延迟)** | **Button_Swap_Prob (换位概率)** |
| --- | --- | --- | --- | --- | --- | --- |
| 1 | Lucid | 80 | 100 | `None` | 0.0s | 0.0 |
| 2 | Anxious | 40 | 79 | `VFX_Vignette_Light` | 0.2s | 0.0 |
| 3 | Panic | 10 | 39 | `VFX_Heartbeat_Heavy` | 0.5s | 0.3 (30%) |
| 4 | Breakdown | 0 | 9 | `VFX_Blood_Screen` | 99s | 1.0 |


### 5.2 `Cfg_Sanity_Item.xlsx` (恢复道具表)
定义在 TripX 里能买到的“精神药剂”。

| **ID** | **Name** | **Cost_Source** | **Recover_Val** | **Side_Effect (副作用)** | **Desc** |
| --- | --- | --- | --- | --- | --- |
| 101 | 电子烟 | 50 | +10 | Health -1 | 稍微缓解焦虑，但在赛博世界也要注意肺。 |
| 102 | 镇静剂 | 200 | +30 | Reaction -20% | 强行压制恐慌，但接下来的操作会变迟钝。 |
| 103 | 昂贵的威士忌 | 500 | +50 | Skip_TimeSlot | 喝醉了就能睡个好觉。消耗 1 个时间槽。 |


---

## 6. UI/UX 详细设计
### 6.1 San 值进度条 (The Brain Bar)
+ **位置:** 屏幕底部或侧边，不是血条，更像是一个**心电图**。
+ **动态:**
    - San 值高时：心电图平稳，绿色。
    - San 值低时：心电图剧烈波动，红色，频率随心率加快。

### 6.2 幻觉系统 (Hallucinations)
这是本作的特色。当处于 **【恐慌】** 状态时，K 线图会出现欺骗性视觉元素。

+ **假信号:** 图表上会随机出现并不存在的“暴跌大阴线”，持续 0.5 秒后消失。吓唬玩家割肉。
+ **怪物投影:** K 线的走势形状隐约组成一只克苏鲁怪物的轮廓（程序生成 Mesh）。

### 6.3 听觉反馈 (Audio)
使用 **FMOD** 或 **Wwise** 实现动态混音。

+ **Layer 1 (BGM):** 正常的赛博/修仙背景乐。
+ **Layer 2 (Noise):** 随着 San 值降低，音量逐渐推大。包含电流声、耳鸣声。
+ **Layer 3 (Heartbeat):** 与玩家手表的真实心率同步（如果有），或者模拟高心率。

